version: 2.1

jobs:
  test:
    docker:
      - image: ubuntu:22.04

    environment:
      MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
      MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
      DISPLAY: ":99"

    steps:
      - checkout

      - restore_cache:
          keys:
            - maven-repo-v1-{{ checksum "pom.xml" }}
            - maven-repo-v1-

      - run:
          name: Cài đặt Java, Maven, Chrome 114 và ChromeDriver 114
          command: |
            set -e

            # ===== Fix mirror Ubuntu =====
            sed -i 's|http://.*.ubuntu.com|http://archive.ubuntu.com|g' /etc/apt/sources.list
            apt-get update

            # ===== Cài dependencies =====
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              wget \
              unzip \
              curl \
              xvfb \
              openjdk-17-jdk \
              maven \
              libglib2.0-0 \
              libnss3 \
              libfontconfig1 \
              libxss1 \
              libasound2 \
              fonts-liberation \
              libu2f-udev \
              libatk-bridge2.0-0 \
              libgtk-3-0 \
              libgbm1 \
              libx11-xcb1 \
              libxcomposite1 \
              libxcursor1 \
              libxdamage1 \
              libxi6 \
              libxtst6 \
              libxrandr2 \
              libxrender1 \
              libcups2 \
              libdrm2 \
              libxkbcommon0 \
              libxshmfence1

            # ===== Cài Google Chrome 114 =====
            wget -O chrome.deb https://www.slimjet.com/chrome/google-chrome-stable_114.0.5735.198-1_amd64.deb
            dpkg -i chrome.deb || apt-get -f install -y
            google-chrome --version

            # ===== Cài ChromeDriver 114 =====
            rm -f src/test/resources/chromedriver
            mkdir -p src/test/resources
            wget -O chromedriver.zip https://chromedriver.storage.googleapis.com/114.0.5735.90/chromedriver_linux64.zip
            unzip chromedriver.zip -d /tmp/
            mv /tmp/chromedriver src/test/resources/
            chmod +x src/test/resources/chromedriver
            src/test/resources/chromedriver --version

            # ===== Khởi động Xvfb =====
            Xvfb :99 -screen 0 1920x1080x24 &
            sleep 3

            ps aux | grep Xvfb | grep -v grep

      - run:
          name: Chạy test Selenium
          command: |
            set -e
            ps aux | grep Xvfb | grep -v grep
            mvn $MAVEN_CLI_OPTS test

      - save_cache:
          paths:
            - .m2/repository
          key: maven-repo-v1-{{ checksum "pom.xml" }}

      - store_artifacts:
          path: target/
          destination: target

      - store_artifacts:
          path: test-output/
          destination: test-output

      - run:
          name: Chuẩn bị JUnit XML cho CircleCI
          command: |
            mkdir -p target/circleci-test-results

            if [ -d "target/surefire-reports/junitreports" ]; then
              cp target/surefire-reports/junitreports/*.xml target/circleci-test-results/ 2>/dev/null || true
            else
              find target/surefire-reports -maxdepth 1 -name "TEST-*.xml" -type f -exec cp {} target/circleci-test-results/ \; 2>/dev/null || true
            fi

            ls -la target/circleci-test-results || true

      - store_test_results:
          path: target/circleci-test-results

workflows:
  version: 2
  test-workflow:
    jobs:
      - test
